name: Release to v3/edge

on:
  workflow_dispatch:
  push:
    tags:
      - 'v3*'

# Note this workflow requires a Github secret to provide auth against charmhub.
# This can be generated with the following command
# charmcraft login --export=secrets.auth --charm=juju-jimm --charm=juju-jimm-k8s --permission=package-manage --permission=package-view --channel=1/edge --channel=3/edge --ttl=999999999

jobs:
  ci-tests:
    uses: ./.github/workflows/ci.yaml
  charm-tests:
    uses: ./.github/workflows/charm-test.yaml
  snap-build:
    uses: ./.github/workflows/snap.yaml

  release-k8s-charm:
    name: Release k8s charm
    needs:
      - ci-tests
      - charm-tests
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true 
      - uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'
      - name: Build local images
        run: make jimm-image
      - name: Upload charm to charmhub
        uses: canonical/charming-actions/upload-charm@2.4.0
        with:
          credentials: "${{ secrets.CHARMHUB_TOKEN }}"
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          channel: "3/edge"
          charm-path: "./charms/jimm-k8s"
          pull-image: "false"
          tag-prefix: "v3-k8s"

  release-machine-charm:
    name: Release machine charm
    needs:
      - ci-tests
      - charm-tests
      - snap-build
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: actions/download-artifact@master
        with:
          name: jimm-snap
      - name: Install charmcraft
        run: sudo snap install charmcraft --channel=2.x/stable --classic
      - name: Publish Charm Resource
        run: charmcraft upload-resource juju-jimm jimm-snap --filepath ./jimm.snap
        env:
          CHARMCRAFT_AUTH: "${{ secrets.CHARMHUB_TOKEN }}"
      - name: Upload charm to charmhub
        uses: canonical/charming-actions/upload-charm@2.3.0
        with:
          credentials: "${{ secrets.CHARMHUB_TOKEN }}"
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          channel: "3/edge"
          charm-path: "./charms/jimm"
          tag-prefix: "v3-machine"
